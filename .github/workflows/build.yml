name: Master Build
on: [push, workflow_dispatch]

jobs:
  build-and-sign:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - uses: android-actions/setup-android@v3
      
      - name: Generate Project Files (Clean Slate)
        run: |
          python3 -c "
          import os
          import shutil
          
          # 1. CLEAN SLATE: Delete 'app' folder if it exists to prevent errors
          if os.path.exists('app'):
              shutil.rmtree('app')
          
          # 2. Create settings.gradle
          with open('settings.gradle', 'w') as f:
              f.write(\"include ':app'\")
          
          # 3. Create Root build.gradle
          with open('build.gradle', 'w') as f:
              f.write(\"buildscript {\\n\")
              f.write(\"    repositories { google(); mavenCentral() }\\n\")
              f.write(\"    dependencies {\\n\")
              f.write(\"        classpath 'com.android.tools.build:gradle:8.1.1'\\n\")
              f.write(\"        classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.0'\\n\")
              f.write(\"    }\\n\")
              f.write(\"}\\n\")
              f.write(\"allprojects { repositories { google(); mavenCentral() } }\\n\")
              f.write(\"task clean(type: Delete) { delete rootProject.buildDir }\\n\")
          
          # 4. Create App build.gradle
          os.makedirs('app', exist_ok=True)
          with open('app/build.gradle', 'w') as f:
              f.write(\"plugins {\\n\")
              f.write(\"    id 'com.android.application'\\n\")
              f.write(\"    id 'org.jetbrains.kotlin.android'\\n\")
              f.write(\"}\\n\")
              f.write(\"android {\\n\")
              f.write(\"    namespace 'com.momrelay'\\n\")
              f.write(\"    compileSdk 34\\n\")
              f.write(\"    defaultConfig {\\n\")
              f.write(\"        applicationId 'com.momrelay'\\n\")
              f.write(\"        minSdk 26\\n\")
              f.write(\"        targetSdk 34\\n\")
              f.write(\"        versionCode 6\\n\")
              f.write(\"        versionName '6.0-Clean'\\n\")
              f.write(\"    }\\n\")
              f.write(\"    buildFeatures { viewBinding true }\\n\")
              f.write(\"}\\n\")
              f.write(\"dependencies {\\n\")
              f.write(\"    implementation 'androidx.core:core-ktx:1.12.0'\\n\")
              f.write(\"    implementation 'androidx.appcompat:appcompat:1.6.1'\\n\")
              f.write(\"    implementation 'com.google.android.material:material:1.11.0'\\n\")
              f.write(\"}\\n\")
          
          # 5. Create Manifest (Android 15 Compatible)
          os.makedirs('app/src/main', exist_ok=True)
          with open('app/src/main/AndroidManifest.xml', 'w') as f:
              f.write(\"<?xml version='1.0' encoding='utf-8'?>\\n\")
              f.write(\"<manifest xmlns:android='http://schemas.android.com/apk/res/android'>\\n\")
              f.write(\"    <uses-permission android:name='android.permission.RECEIVE_SMS' />\\n\")
              f.write(\"    <uses-permission android:name='android.permission.READ_SMS' />\\n\")
              f.write(\"    <uses-permission android:name='android.permission.SEND_SMS' />\\n\")
              f.write(\"    <uses-permission android:name='android.permission.READ_PHONE_STATE' />\\n\")
              f.write(\"    <uses-permission android:name='android.permission.FOREGROUND_SERVICE' />\\n\")
