name: Build MomRelay Final v3
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup & Inject Code
        run: |
          wget https://github.com/feedvay/android-hello-world/archive/refs/heads/master.zip -O project.zip
          unzip project.zip
          mv android-hello-world-master/* .
          rm -rf android-hello-world-master project.zip

          # MANIFEST
          cat <<'EOF' > app/src/main/AndroidManifest.xml
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              xmlns:tools="http://schemas.android.com/tools">
              <uses-permission android:name="android.permission.RECEIVE_SMS" />
              <uses-permission android:name="android.permission.READ_SMS" />
              <uses-permission android:name="android.permission.SEND_SMS" />
              <uses-permission android:name="android.permission.READ_PHONE_STATE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
              <application
                  android:allowBackup="true"
                  android:icon="@mipmap/ic_launcher"
                  android:label="Mom Relay v3"
                  android:theme="@style/Theme.AppCompat.Light.NoActionBar">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <service android:name=".RelayService" android:enabled="true" android:exported="false" android:foregroundServiceType="dataSync" />
                  <receiver android:name=".SmsReceiver" android:enabled="true" android:exported="true" android:permission="android.permission.BROADCAST_SMS">
                      <intent-filter android:priority="999">
                          <action android:name="android.provider.Telephony.SMS_RECEIVED" />
                      </intent-filter>
                  </receiver>
              </application>
          </manifest>
          EOF

          # MAIN ACTIVITY (Now with Input Dialog)
          mkdir -p app/src/main/java/com/momrelay
          cat <<'EOF' > app/src/main/java/com/momrelay/MainActivity.kt
          package com.momrelay
          import android.os.Bundle
          import android.widget.*
          import android.view.Gravity
          import android.content.Intent
          import androidx.appcompat.app.AppCompatActivity
          import android.Manifest
          import androidx.core.app.ActivityCompat
          import android.os.Build
          import android.app.AlertDialog
          import android.content.Context

          class MainActivity : AppCompatActivity() {
              override fun onCreate(s: Bundle?) {
                  super.onCreate(s)
                  
                  // Main Layout
                  val l = LinearLayout(this).apply { 
                      orientation = LinearLayout.VERTICAL
                      gravity = Gravity.CENTER
                      setPadding(60,60,60,60)
                      setBackgroundColor(0xFFF0F4F8.toInt())
                  }
                  
                  // Title
                  val title = TextView(this).apply {
                      text = "SMS RELAY"
                      textSize = 28f
                      gravity = Gravity.CENTER
                      setTextColor(0xFF006C70.toInt())
                      setPadding(0, 0, 0, 40)
                  }
                  
                  // Status Text
                  val status = TextView(this).apply { 
                      text = "Status: Idle"
                      textSize = 16f
                      gravity = Gravity.CENTER
                      setPadding(0,0,0,60)
                  }
                  
                  // The Big Button
                  val btn = Button(this).apply { 
                      text = "CONFIGURE & START" 
                      textSize = 18f
                      setPadding(40, 20, 40, 20)
                  }
                  
                  l.addView(title)
                  l.addView(status)
                  l.addView(btn)
                  setContentView(l)
                  
                  // Load saved data for display
                  val prefs = getSharedPreferences("Relay", Context.MODE_PRIVATE)
                  val savedPhone = prefs.getString("PHONE", "Not Set")
                  val isActive = prefs.getBoolean("ACTIVE", false)
                  
                  if(isActive) {
                      status.text = "ACTIVE\nTarget: $savedPhone"
                      status.setTextColor(0xFF00C853.toInt()) // Green
                      btn.text = "STOP SERVICE"
                  }

                  btn.setOnClickListener {
                      if (prefs.getBoolean("ACTIVE", false)) {
                          // Stop Logic
                          prefs.edit().putBoolean("ACTIVE", false).apply()
                          stopService(Intent(this, RelayService::class.java))
                          status.text = "Status: Stopped"
                          status.setTextColor(0xFFD32F2F.toInt()) // Red
                          btn.text = "CONFIGURE & START"
                          Toast.makeText(this, "Service Stopped", Toast.LENGTH_SHORT).show()
                      } else {
                          // Start Logic -> Show Dialog
                          showConfigDialog(status, btn)
                      }
                  }
                  
                  // Request permissions immediately on open
                  checkPerms()
              }

              private fun showConfigDialog(statusView: TextView, btnView: Button) {
                  val context = this
                  val layout = LinearLayout(context).apply {
                      orientation = LinearLayout.VERTICAL
                      setPadding(50, 40, 50, 10)
                  }

                  val prefs = getSharedPreferences("Relay", Context.MODE_PRIVATE)
                  
                  val inputPhone = EditText(context).apply { 
                      hint = "Target Phone (+91...)" 
                      setText(prefs.getString("PHONE", ""))
                      inputType = android.text.InputType.TYPE_CLASS_PHONE
                  }
                  
                  val inputKeywords = EditText(context).apply { 
                      hint = "Keywords (OTP, Bank, etc.)" 
                      setText(prefs.getString("KEYWORDS", ""))
                  }
                  
                  val helpText = TextView(context).apply {
                      text = "Leave keywords empty to forward ALL messages."
                      textSize = 12f
                      setPadding(0, 10, 0, 0)
                  }

                  layout.addView(inputPhone)
                  layout.addView(inputKeywords)
                  layout.addView(helpText)

                  AlertDialog.Builder(context)
                      .setTitle("Setup Forwarding")
                      .setView(layout)
                      .setPositiveButton("START") { _, _ ->
                          val phone = inputPhone.text.toString().trim()
                          val keywords = inputKeywords.text.toString().trim()
                          
                          if (phone.length < 3) {
                              Toast.makeText(context, "Invalid Phone Number", Toast.LENGTH_SHORT).show()
                              return@setPositiveButton
                          }
                          
                          // Save Data
                          prefs.edit()
                              .putString("PHONE", phone)
                              .putString("KEYWORDS", keywords)
                              .putBoolean("ACTIVE", true)
                              .apply()
                              
                          // Start Service
                          val it = Intent(context, RelayService::class.java)
                          if (Build.VERSION.SDK_INT >= 26) startForegroundService(it) else startService(it)
                          
                          // Update UI
                          statusView.text = "ACTIVE\nTarget: $phone"
                          statusView.setTextColor(0xFF00C853.toInt())
                          btnView.text = "STOP SERVICE"
                          Toast.makeText(context, "Service Started!", Toast.LENGTH_SHORT).show()
                      }
                      .setNegativeButton("Cancel", null)
                      .show()
              }

              private fun checkPerms() {
                  val perms = mutableListOf(
                      Manifest.permission.RECEIVE_SMS, 
                      Manifest.permission.SEND_SMS, 
                      Manifest.permission.READ_PHONE_STATE
                  )
                  if (Build.VERSION.SDK_INT >= 33) perms.add(Manifest.permission.POST_NOTIFICATIONS)
                  ActivityCompat.requestPermissions(this, perms.toTypedArray(), 101)
              }
          }
          EOF

          # RELAY SERVICE
          cat <<'EOF' > app/src/main/java/com/momrelay/RelayService.kt
          package com.momrelay
          import android.app.*
          import android.content.Intent
          import android.os.IBinder
          import androidx.core.app.NotificationCompat
          import android.content.pm.ServiceInfo
          import android.os.Build
          class RelayService : Service() {
              override fun onBind(i: Intent?): IBinder? = null
              override fun onStartCommand(i: Intent?, f: Int, s: Int): Int {
                  try {
                      if (Build.VERSION.SDK_INT >= 26) {
                          val c = NotificationChannel("Relay", "Relay Service", NotificationManager.IMPORTANCE_LOW)
                          getSystemService(NotificationManager::class.java).createNotificationChannel(c)
                      }
                      val n = NotificationCompat.Builder(this, "Relay")
                          .setContentTitle("Mom Relay Active")
                          .setSmallIcon(android.R.drawable.ic_dialog_email)
                          .build()
                      if (Build.VERSION.SDK_INT >= 34) {
                          startForeground(1, n, ServiceInfo.FOREGROUND_SERVICE_TYPE_DATA_SYNC)
                      } else {
                          startForeground(1, n)
                      }
                  } catch (e: Exception) { e.printStackTrace() }
                  return START_STICKY
              }
          }
          EOF

          # SMS RECEIVER (Updated with Keyword Logic)
          cat <<'EOF' > app/src/main/java/com/momrelay/SmsReceiver.kt
          package com.momrelay
          import android.content.*
          import android.telephony.*
          class SmsReceiver : BroadcastReceiver() {
              override fun onReceive(c: Context, i: Intent) {
                  if (i.action != "android.provider.Telephony.SMS_RECEIVED") return
                  
                  val prefs = c.getSharedPreferences("Relay", Context.MODE_PRIVATE)
                  if (!prefs.getBoolean("ACTIVE", false)) return
                  
                  val target = prefs.getString("PHONE", "") ?: return
                  val rawKeywords = prefs.getString("KEYWORDS", "") ?: ""
                  
                  val bundle = i.extras ?: return
                  val pdus = bundle.get("pdus") as Array<Any>?
                  val sms = SmsManager.getDefault()
                  
                  pdus?.forEach {
                      val msg = SmsMessage.createFromPdu(it as ByteArray, bundle.getString("format"))
                      val body = msg.messageBody ?: ""
                      
                      if (shouldSend(body, rawKeywords)) {
                          try { 
                              sms.sendTextMessage(target, null, "Fwd: $body", null, null) 
                          } catch (e: Exception) {}
                      }
                  }
              }
              
              private fun shouldSend(body: String, keywords: String): Boolean {
                  if (keywords.isEmpty()) return true // No keywords = Send All
                  val keys = keywords.split(",").map { it.trim().lowercase() }
                  val lowerBody = body.lowercase()
                  for (k in keys) {
                      if (k.isNotEmpty() && lowerBody.contains(k)) return true
                  }
                  return false
              }
          }
          EOF

          # GRADLE CONFIG
          echo "android { namespace 'com.momrelay'; compileSdk 34; defaultConfig { applicationId 'com.momrelay'; minSdk 26; targetSdk 34; versionCode 1; } }" >> app/build.gradle

      - name: Build APK
        run: ./gradlew assembleDebug

      - uses: actions/upload-artifact@v4
        with:
          name: MomRelay-App-v3
          path: app/build/outputs/apk/debug/app-debug.apk

3. Conclusion & Suggestions
This updated workflow file (build.yml) replaces the simple Start button with a smart "Configure & Start" button.
What's new:
 * Pop-up Dialog: When you tap the main button, a dialog box appears.
 * Input Fields: You can type the Phone Number and Keywords (separated by commas) directly in this box.
 * Smart Filtering: The SMS Receiver now checks the message content against your keywords. If the keywords box is empty, it forwards everything. If you type "OTP, Bank", it only forwards messages containing those words.
 * Visual Feedback: The main screen will update to show "ACTIVE" in green and display the target number you set.
To Apply:
 * Edit .github/workflows/build.yml in your repository.
 * Delete everything and paste the new code above.
 * Commit and wait for the build to finish (Green checkmark).
 * Download the new MomRelay-App-v3 artifact.
Let me know if you have any questions about using the keywords feature!

